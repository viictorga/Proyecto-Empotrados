#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <AsyncTCP.h>
#include <ESPAsyncWebServer.h>
#include <DHT.h>
#include <ArduinoJson.h>
#include <UniversalTelegramBot.h>
#include <HTTPClient.h>

// ----------- CONFIG SENSORES -----------
#define DHTPIN 4
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);
float temperature = 0.0;
float humidity = 0.0;
bool tempAlertActive = false;
bool humAlertActive  = false;


// ----------- CONFIG OWM -----------
const char* city = "Madrid,ES";
const char* apiKey = "27d3ec1f8b83dedf587fe5f9956f37d5"; // tu API Key OpenWeatherMap

float ow_tempMin = 0;
float ow_tempMax = 0;
int ow_humidity = 0;
String ow_description = "";

unsigned long lastWeatherCall = 0;
const unsigned long weatherInterval = 60000; // 60s

// ----------- CONFIG WIFI -----------
const char* ssid = "Victor S24";
const char* password = "Gorjon23";

// ----------- CONFIG TELEGRAM -----------
#define BOT_TOKEN "7245526733:AAExEEXnTjtndfg_DMQ3X0Drs6v7ivKR-ko"
#define CHAT_ID "5036043110"
WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);
unsigned long lastAlertTime = 0;
const unsigned long alertInterval = 60000; // 1 minuto

// ----------- UMBRALES -----------
const float TEMP_THRESHOLD = 30.0;
const float HUM_THRESHOLD = 70.0;

// ----------- SERVIDOR WEB -----------
AsyncWebServer server(80);

// ==========================
//     WEATHER API FUNCTION
// ==========================
void fetchWeather() {
  if (millis() - lastWeatherCall < weatherInterval) return;
  lastWeatherCall = millis();

  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  String url = "http://api.openweathermap.org/data/2.5/weather?q=" +
               String(city) + "&appid=" + String(apiKey);

  http.begin(url);
  int code = http.GET();

  if (code == HTTP_CODE_OK) {
    String payload = http.getString();
    StaticJsonDocument<1024> doc;
    DeserializationError err = deserializeJson(doc, payload);
    if (!err) {
      float tempMinK = doc["main"]["temp_min"] | 0.0;
      float tempMaxK = doc["main"]["temp_max"] | 0.0;
      ow_humidity = doc["main"]["humidity"] | 0;
      const char* desc = doc["weather"][0]["description"] | "";

      ow_tempMin = tempMinK - 273.15;
      ow_tempMax = tempMaxK - 273.15;
      ow_description = String(desc);

      Serial.println("=== OpenWeatherMap ===");
      Serial.printf("Min: %.1f ¬∞C\n", ow_tempMin);
      Serial.printf("Max: %.1f ¬∞C\n", ow_tempMax);
      Serial.printf("Hum: %d %%\n", ow_humidity);
      Serial.printf("Desc: %s\n", ow_description.c_str());
      Serial.println("======================");
    } else {
      Serial.println("Error parseando JSON OWM");
    }
  } else {
    Serial.printf("HTTP error OWM: %d\n", code);
  }

  http.end();
}
String getWeatherSummary(String desc) {
  desc.toLowerCase();

  if (desc.indexOf("clear") != -1) {
    return "Cielo despejado y condiciones estables.";
  }
  if (desc.indexOf("cloud") != -1) {
    return "Cielo parcialmente nublado.";
  }
  if (desc.indexOf("rain") != -1) {
    return "Lluvia ligera en el exterior.";
  }
  if (desc.indexOf("heavy") != -1 || desc.indexOf("storm") != -1) {
    return "Condiciones de tormenta o lluvia fuerte.";
  }
  if (desc.indexOf("snow") != -1) {
    return "Nevadas o ambiente muy fr√≠o.";
  }
  if (desc.indexOf("fog") != -1 || desc.indexOf("mist") != -1) {
    return "Ambiente con niebla o visibilidad reducida.";
  }

  return "Condiciones variables.";
}
void handleTelegramMessages() {
  int numNewMessages = bot.getUpdates(bot.last_message_received + 1);

  while (numNewMessages) {
    for (int i = 0; i < numNewMessages; i++) {

      String text = bot.messages[i].text;
      String chat_id = bot.messages[i].chat_id;

      if (text == "/info") {

        String reply = "üìä *Informe completo de la estaci√≥n:*\n\n";

        reply += "üå° *DHT11*\n";
        reply += " ‚Ä¢ Temperatura: " + String(temperature, 1) + " ¬∞C\n";
        reply += " ‚Ä¢ Humedad: " + String(humidity, 1) + " %\n\n";

        reply += "üåç *OpenWeatherMap*\n";
        reply += " ‚Ä¢ M√≠nima: " + String(ow_tempMin, 1) + " ¬∞C\n";
        reply += " ‚Ä¢ M√°xima: " + String(ow_tempMax, 1) + " ¬∞C\n";
        reply += " ‚Ä¢ Humedad: " + String(ow_humidity) + "%\n";
        reply += " ‚Ä¢ Descripci√≥n: " + ow_description + "\n";
        reply += " ‚Ä¢ Resumen: " + getWeatherSummary(ow_description) + "\n\n";

        reply += "‚öô *Sistema*\n";
        reply += " ‚Ä¢ IP: " + WiFi.localIP().toString() + "\n";
        reply += " ‚Ä¢ Uptime: " + String(millis()/1000) + " s\n";
        reply += " ‚Ä¢ Umbral Temp: " + String(TEMP_THRESHOLD) + " ¬∞C\n";
        reply += " ‚Ä¢ Umbral Humedad: " + String(HUM_THRESHOLD) + " %\n";

        bot.sendMessage(chat_id, reply, "Markdown");
      }
    }

    numNewMessages = bot.getUpdates(bot.last_message_received + 1);
  }
}



// ==========================
//            SETUP
// ==========================
void setup() {
  Serial.begin(115200);
  delay(10);

  dht.begin();
  WiFi.begin(ssid, password);

  Serial.print("Conectando a WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\n‚úÖ WiFi Conectado!");
  Serial.println(WiFi.localIP());
  client.setInsecure();

  // ---- ENDPOINT JSON /data ----
  server.on("/data", HTTP_GET, [](AsyncWebServerRequest *request){
    DynamicJsonDocument doc(512);
    doc["temperature"] = isnan(temperature) ? 0.0 : temperature;
    doc["humidity"] = isnan(humidity) ? 0.0 : humidity;

    doc["ow_tempMin"] = ow_tempMin;
    doc["ow_tempMax"] = ow_tempMax;
    doc["ow_humidity"] = ow_humidity;
    doc["ow_description"] = ow_description;

    // small telemetry
    doc["ip"] = WiFi.localIP().toString();

    String json;
    serializeJson(doc, json);
    request->send(200, "application/json", json);
  });

  // ---- DASHBOARD (Bootstrap + Chart.js) ----
  server.on("/", HTTP_GET, [](AsyncWebServerRequest *request){
    request->send_P(200, "text/html", R"rawliteral(
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Estaci√≥n Meteorol√≥gica - Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background:#f5f7fb; }
    .card { border-radius:12px; box-shadow:0 8px 18px rgba(0,0,0,0.08); }
    .value { font-size:2rem; font-weight:700; }
    .icon-circle{
        width:52px;height:52px;border-radius:50%;
        display:flex;align-items:center;justify-content:center;
    }
    .weather-icon {
        font-size:2.5rem;
        margin-right:10px;
    }
    .desc { text-transform:capitalize; font-size:1.3rem; font-weight:600; }
  </style>
</head>

<body>
<div class="container py-4">

  <h2 class="mb-4"><i class="bi bi-cloud-sun"></i> Estaci√≥n Meteorol√≥gica</h2>

  <!-- NAV TABS -->
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="dht-tab" data-bs-toggle="tab" data-bs-target="#dht" type="button">
        <i class="bi bi-thermometer"></i> Sensor DHT
      </button>
    </li>

    <li class="nav-item">
      <button class="nav-link" id="owm-tab" data-bs-toggle="tab" data-bs-target="#owm" type="button">
        <i class="bi bi-cloud"></i> OpenWeatherMap
      </button>
    </li>
  </ul>

  <div class="tab-content mt-4">

    <!-- TAB 1: DHT -->
    <div class="tab-pane fade show active" id="dht" role="tabpanel">
      <div class="row g-3">

        <div class="col-md-6">
          <div class="card p-3">
            <div class="d-flex">
              <div class="icon-circle" style="background:#ffb3b3;">
                <i class="bi bi-thermometer-half fs-4"></i>
              </div>
              <div class="ms-3">
                <small class="text-muted">Temperatura (DHT)</small>
                <div id="card-temp" class="value">-- ¬∞C</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card p-3">
            <div class="d-flex">
              <div class="icon-circle" style="background:#b3d8ff;">
                <i class="bi bi-droplet fs-4"></i>
              </div>
              <div class="ms-3">
                <small class="text-muted">Humedad (DHT)</small>
                <div id="card-hum" class="value">-- %</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- TAB 2: OWM -->
    <div class="tab-pane fade" id="owm" role="tabpanel">

      <div class="row g-3">

        <div class="col-md-4">
          <div class="card p-3">
            <div class="d-flex">
              <div class="icon-circle" style="background:#ffe5b3;">
                <i class="bi bi-thermometer-snow fs-4"></i>
              </div>
              <div class="ms-3">
                <small class="text-muted">M√≠nima (OWM)</small>
                <div id="card-ow-min" class="value">-- ¬∞C</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card p-3">
            <div class="d-flex">
              <div class="icon-circle" style="background:#ffcab3;">
                <i class="bi bi-thermometer-high fs-4"></i>
              </div>
              <div class="ms-3">
                <small class="text-muted">M√°xima (OWM)</small>
                <div id="card-ow-max" class="value">-- ¬∞C</div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card p-3">
            <div class="d-flex align-items-center">
              <div class="icon-circle" style="background:#b3ffc4;">
                <i class="bi bi-moisture fs-4"></i>
              </div>
              <div class="ms-3">
                <small class="text-muted">Humedad (OWM)</small>
                <div id="card-ow-hum" class="value">-- %</div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="card p-3 mt-3">
        <div class="d-flex align-items-center">
          <i id="weather-icon" class="weather-icon bi bi-cloud"></i>
          <div>
            <small class="text-muted">Descripci√≥n del clima</small>
            <div id="ow-desc" class="desc">--</div>
          </div>
        </div>
      </div>

    </div>

  </div>

  <!-- GRAFICO GRANDE YA PARA AMBAS PESTA√ëAS -->
  <div class="card p-4 mt-4">
    <h5><i class="bi bi-graph-up"></i> Gr√°fico en vivo</h5>
    <canvas id="mainChart" height="350"></canvas>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

let maxHistory = 40;

const ctx = document.getElementById("mainChart").getContext("2d");
const data = {
  labels: [],
  datasets: [
    { label:"Temp DHT", data:[], borderColor:"#ff6b6b", tension:0.25 },
    { label:"Hum DHT", data:[], borderColor:"#4dabf7", tension:0.25 },
    { label:"OWM Min", data:[], borderColor:"#f2a900", tension:0.25 },
    { label:"OWM Max", data:[], borderColor:"#ff4f81", tension:0.25 }
  ]
};

const mainChart = new Chart(ctx, {
  type:"line",
  data:data,
  options:{ scales:{ y:{ beginAtZero:false } } }
});

function weatherIconFromDescription(desc){
  desc = desc.toLowerCase();

  if(desc.includes("rain")) return "bi-cloud-rain";
  if(desc.includes("clear")) return "bi-brightness-high";
  if(desc.includes("cloud")) return "bi-clouds";
  if(desc.includes("snow")) return "bi-snow";
  if(desc.includes("storm")) return "bi-cloud-lightning";
  return "bi-cloud";
}

async function updateDashboard(){
  const res = await fetch("/data");
  const j = await res.json();

  // DHT
  document.getElementById("card-temp").textContent = j.temperature.toFixed(1)+" ¬∞C";
  document.getElementById("card-hum").textContent  = j.humidity.toFixed(1)+" %";

  // OWM
  document.getElementById("card-ow-min").textContent = j.ow_tempMin.toFixed(1)+" ¬∞C";
  document.getElementById("card-ow-max").textContent = j.ow_tempMax.toFixed(1)+" ¬∞C";
  document.getElementById("card-ow-hum").textContent = j.ow_humidity+" %";

  document.getElementById("ow-desc").textContent = j.ow_description;

  // icono din√°mico
  const icon = weatherIconFromDescription(j.ow_description);
  document.getElementById("weather-icon").className = "weather-icon bi "+icon;

  // gr√°fico
  const now = new Date().toLocaleTimeString();
  data.labels.push(now);
  data.datasets[0].data.push(j.temperature);
  data.datasets[1].data.push(j.humidity);
  data.datasets[2].data.push(j.ow_tempMin);
  data.datasets[3].data.push(j.ow_tempMax);

  if(data.labels.length > maxHistory){
    data.labels.shift();
    data.datasets.forEach(ds => ds.data.shift());
  }

  mainChart.update();
}

setInterval(updateDashboard, 2000);

</script>

</body>
</html>


    )rawliteral");
  });

  server.begin();
}

// ==========================
//            LOOP
// ==========================
void loop() {
  handleTelegramMessages();
  // Leer sensor DHT cada 2s
  static unsigned long lastReadTime = 0;
  if (millis() - lastReadTime > 2000) {
    lastReadTime = millis();
    float t = dht.readTemperature();
    float h = dht.readHumidity();
    if (!isnan(t)) temperature = t;
    if (!isnan(h)) humidity = h;
    Serial.printf("DHT -> Temp: %.1f C, Hum: %.1f %%\n", temperature, humidity);
  }

  // Llamada a OpenWeatherMap
  fetchWeather();

  // Alertas Telegram (por si quieres mantenerlas)
// ===============================
//   ALERTAS SOLO AL CRUZAR UMBRAL
// ===============================

// --- TEMPERATURA ALTA ---
if (temperature > TEMP_THRESHOLD) {
  if (!tempAlertActive) {  
    // ‚ö† Se acaba de superar el umbral ‚Üí enviar alerta
    String msg = "üî• *ALERTA: Temperatura alta*\n";
    msg += "Temperatura actual: " + String(temperature, 1) + " ¬∞C\n\n";

    msg += "üåç *Condiciones exteriores:* " + ow_description + "\n";
    msg += "üìÑ " + getWeatherSummary(ow_description) + "\n";

    bot.sendMessage(CHAT_ID, msg, "Markdown");

    tempAlertActive = true;
  }
} else {
  // Ha vuelto a la normalidad ‚Üí se resetea
  tempAlertActive = false;
}


// --- HUMEDAD ALTA ---
if (humidity > HUM_THRESHOLD) {
  if (!humAlertActive) {
    String msg = "üíß *ALERTA: Humedad alta*\n";
    msg += "Humedad actual: " + String(humidity, 1) + " %\n\n";

    msg += "üåç *Condiciones exteriores:* " + ow_description + "\n";
    msg += "üìÑ " + getWeatherSummary(ow_description) + "\n";

    bot.sendMessage(CHAT_ID, msg, "Markdown");

    humAlertActive = true;
  }
} else {
  humAlertActive = false;
}



  // evita bloquear loop con delays largos - peque√±a pausa
  delay(10);
}
