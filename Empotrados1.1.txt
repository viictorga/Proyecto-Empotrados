#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>


const char* ssid = "RubenGalaxy";
const char* password = "akle3151";
const char* city = "Madrid,ES";
const char* apiKey = "27d3ec1f8b83dedf587fe5f9956f37d5";


void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);


  Serial.print("Conectando a WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi conectado!");
}


void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    String url = "http://api.openweathermap.org/data/2.5/weather?q=" + String(city) + "&appid=" + String(apiKey);
    http.begin(url);


    int httpResponseCode = http.GET();


    if (httpResponseCode > 0) {
      String payload = http.getString();
      StaticJsonDocument<1024> doc;
      DeserializationError error = deserializeJson(doc, payload);


      if (!error) {
        float tempMinK = doc["main"]["temp_min"];
        float tempMaxK = doc["main"]["temp_max"];
        int humidity = doc["main"]["humidity"];
        const char* description = doc["weather"][0]["description"];


        int tempMinC = tempMinK - 273.15;
        int tempMaxC = tempMaxK - 273.15;


        Serial.println("=== Clima en Madrid ===");
        Serial.print("Minima: "); Serial.print(tempMinC); Serial.println(" °C");
        Serial.print("Maxima: "); Serial.print(tempMaxC); Serial.println(" °C");
        Serial.print("Humedad: "); Serial.print(humidity); Serial.println("%");
        Serial.print("Descripcion: "); Serial.println(description);
        Serial.println("======================");
      } else {
        Serial.println("Error al parsear JSON");
      }


    } else {
 Serial.print("Error en HTTP: ");
      Serial.println(httpResponseCode);
    }


    http.end();
  } else {
    Serial.println("WiFi desconectado");
  }


  delay(60000);
}

